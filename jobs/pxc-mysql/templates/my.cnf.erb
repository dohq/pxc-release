<%
  base_folder = '/var/vcap/sys/run/pxc-mysql'

  instance_addresses = link('mysql').instances.map { |instance| instance.address }

  def discover_external_ip
    networks = spec.networks.marshal_dump
    _, network = networks.find do |_name, network_spec|
      network_spec.default
    end
    if !network
      _, network = networks.first
    end
    if !network
      raise "Could not determine IP via network spec: #{networks}"
    end
    network.ip
  end

  def csv_excluded_audit_users
    if_p('server_audit_excluded_users_csv') do |user_csv|
      return user_csv.split(',')
    end.else do
      return []
    end
  end

  def excluded_audit_users
    users = p('server_audit_excluded_users') + csv_excluded_audit_users
    ["'galera-agent'@'127.0.0.1'", "'cluster-health-logger'@'127.0.0.1'"] + users.collect {|user| "'#{user}'@'%'"}
  end

  def bool_to_on_off(boolean)
    return "ON" if boolean
    "OFF"
  end

  node_host = discover_external_ip
  if_p('advertise_host') do |advertise_host|
    node_host = advertise_host
  end

  if_p('innodb_flush_method') do |innodb_flush_method|
    if innodb_flush_method != 'O_DIRECT'
        raise "Only innodb-flush-method=O_DIRECT or unset is supported!"
    end
  end
%>

[client]
port                            = <%= p('port') %>
socket                          = <%= "#{base_folder}/mysqld.sock" %>

!include                        /var/vcap/jobs/pxc-mysql/config/auto-tune.cnf

[mysqld]
server-id                       = <%= 1 + index %>
ssl-ca=/var/vcap/jobs/pxc-mysql/certificates/server-ca.pem
ssl-cert=/var/vcap/jobs/pxc-mysql/certificates/server-cert.pem
ssl-key=/var/vcap/jobs/pxc-mysql/certificates/server-key.pem

require-secure-transport = <%= bool_to_on_off(p('require_secure_transport')) %>

<% if p('enable_galera') %>
# GALERA options:
pxc-strict-mode                 = <%= p('pxc_strict_mode') %>
wsrep_on                        = ON
wsrep_provider                  = /var/vcap/packages/libgalera/lib/libgalera_smm.so
wsrep_provider_options          = "gcache.size=<%= p('gcache_size') %>M;pc.recovery=FALSE;pc.checksum=TRUE;socket.ssl=yes;socket.ssl_ca=/var/vcap/jobs/pxc-mysql/certificates/galera-ca.pem;socket.ssl_cert=/var/vcap/jobs/pxc-mysql/certificates/galera-cert.pem;socket.ssl_key=/var/vcap/jobs/pxc-mysql/certificates/galera-key.pem"
wsrep_cluster_address           = gcomm://<%= instance_addresses.join(",") %>
wsrep_node_address              = <%= node_host %>:<%= p('galera_port') %>
wsrep_node_name                 = <%= name %>/<%= index %>
wsrep_cluster_name              = <%= p('cluster_name') %>
wsrep_sst_method                = xtrabackup-v2
wsrep_sst_auth                  = <%= p('admin_username')%>:<%= p('admin_password') %>
wsrep_max_ws_rows               = <%= p('wsrep_max_ws_rows') %>
wsrep_max_ws_size               = <%= p('wsrep_max_ws_size') %>
wsrep_load_data_splitting       = ON
wsrep_replicate_myisam          = OFF
wsrep_debug                     = <%= p('wsrep_debug') %>
sql-mode                        = NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION,STRICT_ALL_TABLES
# required for galera
innodb_support_xa               = OFF
<% if p('log_conflicts') %>
wsrep_log_conflicts             = ON
<% end %>
<% end %>

# Regular MYSQL options:
#character_set_server            = <%= p('character_set_server') %>
#collation_server                = <%= p('collation_server') %>
# Character Set
character-set-server = <%= p('default_char_set') %>
<% if_p('default_collation') do |value| %>
collation-server = <%= value %>
<% end %>
user                            = vcap
socket                          = <%= "#{base_folder}/mysqld.sock" %>
port                            = <%= p('port') %>
basedir                         = /var/vcap/packages/pxc
datadir                         = /var/vcap/store/pxc-mysql
tmpdir                          = /var/vcap/data/pxc-mysql/tmp
pid-file                        = /var/vcap/sys/run/pxc-mysql/mysql.pid
log_error                       = /var/vcap/sys/log/pxc-mysql/mysql.err.log
init_file                       = /var/vcap/jobs/pxc-mysql/config/db_init
symbolic-links                  = OFF
secure_file_priv                = /var/vcap/data/pxc-mysql/files
table_definition_cache          = <%= p('table_definition_cache_size') %>
table_open_cache                = <%= p('table_open_cache') %>

max_allowed_packet              = <%= p('max_allowed_packet') %>
skip_name_resolve               = ON

#enforce_storage_engine          = InnoDB
#FIXME: mysql_upgrade fails if this is turned on

local-infile                    = <%= bool_to_on_off(p('local_infile')) %>
<% if p('binlog_enabled') %>
log-bin                         = mysql-bin
log-slave-updates               = ON
log-bin-trust-function-creators = ON
expire-logs-days                = <%= p('binlog_expire_days') %>
<% end %>

# Replication
<% if !p('enable_galera') %>
binlog-row-image                = minimal
binlog-rows-query-log-events    = ON
binlog-stmt-cache-size          = 4M
enforce-gtid-consistency        = ON
gtid-mode                       = ON
master-info-repository          = TABLE
master-verify-checksum          = ON
max-binlog-cache-size           = 2G
max-binlog-size                 = 512M
max-binlog-stmt-cache-size      = 2G
relay-log                       = mysql-relay
relay-log-info-repository       = TABLE
slave-sql-verify-checksum       = ON
super-read-only                 = <%= p('leader_follower.enabled') ? "ON" : "OFF" %>
relay-log-recovery = ON
sync-binlog = <%= p('sync_binlog') %>

!includedir /var/vcap/sys/run/pxc-mysql/lf-state
<% end %>

<% if p('leader_follower.enabled') && p('leader_follower.replication_mode') == 'semi-sync' %>
plugin-load-add                 = semisync_master.so
plugin-load-add                 = semisync_slave.so
rpl-semi-sync-slave-enabled     = on
rpl-semi-sync-master-timeout    = <%= p('leader_follower.semi_sync_ack_timeout_in_ms') %>
<% end %>


# Required for user to create triggers when binlog is enabled
log_bin_trust_function_creators = 1

# Slow query logging:
slow_query_log                  = ON
slow_query_log_file             = /var/vcap/sys/log/pxc-mysql/mysql_slow_query.log
long_query_time                 = <%= p('long_query_time') %>
<% if p('log_queries_not_using_indexes') %>
log_queries_not_using_indexes   = ON
<% end %>

max_heap_table_size             = <%= p('max_heap_table_size') %>
tmp_table_size                  = <%= p('tmp_table_size') %>
query_cache_type                = OFF

# User statistics
userstat                        = <%= bool_to_on_off(p('userstat')) %>

innodb_file_per_table           = ON
innodb_log_file_size            = <%= p('ib_log_file_size')%>MB

innodb_large_prefix             = = <%= bool_to_on_off(p('innodb_large_prefix_enabled')) %>

innodb_strict_mode             = = <%= bool_to_on_off(p('innodb_strict_mode')) %>

# These are mandatory MySQL settings for Galera to work
innodb_autoinc_lock_mode        = 2

<%
  if not [0, 1, 2].include?(p('innodb_flush_log_at_trx_commit'))
    raise("innodb_flush_log_at_trx_commit value is invalid")
  end
%>
innodb_flush_log_at_trx_commit  = <%= p('innodb_flush_log_at_trx_commit') %>

<% if_p('innodb_lock_wait_timeout') do |innodb_lock_wait_timeout| %>
innodb_lock_wait_timeout        = <%= innodb_lock_wait_timeout %>
<% end %>
<% if_p('innodb_buffer_pool_size') do |innodb_buffer_pool_size| %>
innodb_buffer_pool_size         = <%= innodb_buffer_pool_size %>
<% end %>
<% if_p('innodb_buffer_pool_instances') do |innodb_buffer_pool_instances| %>
innodb_buffer_pool_instances    = <%= innodb_buffer_pool_instances %>
<% end %>
<% if_p('innodb_flush_method') do |innodb_flush_method| %>
innodb_flush_method             = <%= innodb_flush_method %>
<% end %>

innodb_log_buffer_size          = <%= p('innodb_log_buffer_size') %>

max_connections                 = <%= p('max_connections') %>

# Event Scheduler
event_scheduler                 = <%= bool_to_on_off(p('event_scheduler')) %>
lower-case-table-names          = <%= p('enable_lower_case_table_names') ? 1 : 0 %>
myisam-recover-options          = backup,force

<% if p('audit_log.enabled') %>
plugin-load                     = audit_log=audit_log.so
<% if p('enable_galera') %>
audit_log_file                  = /var/vcap/store/mysql_audit_logs/mysql_server_audit.log
audit_log_format                = JSON
audit_log_exclude_accounts      = "<%= excluded_audit_users.join(',') %>"
<% else %>
audit-log-file = /var/vcap/sys/log/mysql/mysql_audit_log
audit-log-format = CSV
audit-log-rotate-on-size = 50M
audit-log-rotations = 5
<% end %>
<% end %>

# SST tls
<% if p('enable_galera') %>
[sst]
encrypt=4
ssl-ca=/var/vcap/jobs/pxc-mysql/certificates/galera-ca.pem
ssl-cert=/var/vcap/jobs/pxc-mysql/certificates/galera-cert.pem
ssl-key=/var/vcap/jobs/pxc-mysql/certificates/galera-key.pem
<% end %>

[mysqldump]
quick
quote-names
max_allowed_packet              = <%= p('max_allowed_packet') %>

[mysql]
max_allowed_packet              = <%= p('max_allowed_packet') %>

[isamchk]
key_buffer                      = 16M
